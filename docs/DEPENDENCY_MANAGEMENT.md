# Dependency Management

## Overview

This project uses **pip-tools** for deterministic dependency management, ensuring reproducible builds across environments.

## File Structure

### Source Files (`.in` files)
- **`requirements.in`** - Direct production dependencies with minimum versions
- **`requirements-dev.in`** - Direct development dependencies

### Generated Files (`.txt` files)
- **`requirements.txt`** - Locked production dependencies with exact versions
- **`requirements-dev.txt`** - Locked development dependencies with exact versions

## Workflow

### Initial Setup

```bash
# Install pip-tools
pip install pip-tools

# Generate locked requirements
make compile-deps

# Or manually:
pip-compile --resolver=backtracking requirements.in
pip-compile --resolver=backtracking requirements-dev.in
```

### Installing Dependencies

```bash
# Production only
make install

# Development (includes production)
make install-dev

# Or with pip directly:
pip install -r requirements.txt
pip install -r requirements-dev.txt
```

### Adding New Dependencies

**Option 1: Edit .in file (Recommended)**
```bash
# Add to requirements.in or requirements-dev.in
echo "new-package>=1.0.0" >> requirements.in

# Recompile
make compile-deps

# Install
make install
```

**Option 2: Use pip-tools directly**
```bash
pip-compile --upgrade-package new-package requirements.in
```

### Updating Dependencies

**Update all to latest compatible versions:**
```bash
make update-deps
```

**Update specific package:**
```bash
pip-compile --upgrade-package click requirements.in
```

**Update everything (including breaking changes):**
```bash
# Edit .in files to allow new versions, then:
make compile-deps
```

### Checking for Security Issues

```bash
make security

# Or manually:
safety check
bandit -r src/
```

## Why pip-tools?

### Benefits

1. **Reproducibility** - Exact versions locked in `.txt` files
2. **Transparency** - See full dependency tree with comments
3. **Easy updates** - Simple commands to update safely
4. **Compatibility** - Works with existing pip workflow
5. **No new tools** - Uses standard `requirements.txt` format

### Example Output

**requirements.in:**
```
click>=8.1.0
requests>=2.31.0
```

**Generated requirements.txt:**
```
#
# This file is autogenerated by pip-compile with Python 3.12
# by the following command:
#
#    pip-compile requirements.in
#
certifi==2024.2.2
    # via requests
charset-normalizer==3.3.2
    # via requests
click==8.1.7
    # via -r requirements.in
idna==3.6
    # via requests
requests==2.31.0
    # via -r requirements.in
urllib3==2.2.1
    # via requests
```

## Alternative: Using pip freeze

If you prefer not to use pip-tools:

```bash
# Generate from current environment
make freeze

# This creates requirements-frozen.txt with exact versions
pip freeze > requirements.txt
```

**Drawbacks:**
- ❌ No separation of direct vs transitive dependencies
- ❌ Harder to see why packages are installed
- ❌ Includes packages from all sources (harder to maintain)

## Alternative: Poetry

For new projects, consider Poetry:

```bash
pip install poetry
poetry init
poetry add click spdx-tools requests pydantic
poetry install
```

**Pros:**
- ✅ Modern, all-in-one tool
- ✅ Excellent dependency resolution
- ✅ Virtual environment management
- ✅ Build and publish support

**Cons:**
- ❌ Different workflow from pip
- ❌ Requires learning new tool
- ❌ May complicate CI/CD initially

## Best Practices

### 1. Always Pin Production Dependencies

**❌ Don't:**
```
requests
click
```

**✅ Do:**
```
requests>=2.31.0,<3.0.0
click>=8.1.0,<9.0.0
```

### 2. Use Compatible Release Specifier

```
# Allow patch updates only
package==1.2.*

# Allow minor updates (recommended)
package~=1.2.3  # equivalent to >=1.2.3,<1.3.0

# Allow minor and patch (flexible)
package>=1.2.0,<2.0.0
```

### 3. Regular Updates

```bash
# Weekly or monthly:
make update-deps
make test
make security
```

### 4. Document Breaking Changes

When updating dependencies with breaking changes, document in:
- `CHANGELOG.md`
- Git commit message
- Update documentation

### 5. CI/CD Integration

**.github/workflows/ci.yml:**
```yaml
- name: Install dependencies
  run: |
    pip install -r requirements.txt
    pip install -r requirements-dev.txt

- name: Check for security issues
  run: |
    pip install safety
    safety check
```

## Makefile Commands

```bash
make help           # Show all available commands
make compile-deps   # Lock dependencies with exact versions
make update-deps    # Update to latest compatible versions
make install        # Install production dependencies
make install-dev    # Install all dependencies
make freeze         # Generate requirements from current env
make test           # Run tests
make lint           # Run linters
make security       # Run security checks
make clean          # Clean build artifacts
```

## Troubleshooting

### Dependency Conflict

```bash
# Clear cache and retry
pip cache purge
rm -rf requirements.txt requirements-dev.txt
make compile-deps
```

### Outdated pip-tools

```bash
pip install --upgrade pip-tools
make compile-deps
```

### Security Vulnerability

```bash
# Check which package has vulnerability
safety check --output text

# Update specific package
pip-compile --upgrade-package vulnerable-package requirements.in

# Or update all
make update-deps
```

## References

- [pip-tools Documentation](https://github.com/jazzband/pip-tools)
- [Poetry Documentation](https://python-poetry.org/)
- [PEP 440 - Version Specifiers](https://peps.python.org/pep-0440/)
- [Python Packaging User Guide](https://packaging.python.org/)
